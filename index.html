<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management System - Orange Theme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        /* General Reset and Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #FFCA28 0%, #FFA000 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: all 0.3s ease;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* Header and Buttons */
        .header {
            background: #FFA000;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: relative;
            transition: all 0.3s ease;
        }

        .header h1 {
            font-size: 1.8em;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn-add {
            background: white;
            color: #FFA000;
        }

        .btn-add:hover {
            background: #f8f9fa;
        }

        .btn-print {
            background: white;
            color: #FFA000;
            border: 2px solid transparent;
        }

        .btn-print:hover {
            background: #f8f9fa;
            border-color: #FFA000;
        }

        .btn-sm.btn-print {
            background: #2196F3;
            color: white;
            border: none;
        }

        .btn-sm.btn-print:hover {
            background: #1976D2;
        }

        .btn-primary {
            background: #FFA000;
            color: white;
        }

        .btn-primary:hover {
            background: #FF8F00;
        }

        .btn-secondary {
            background: #E0E0E0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #D0D0D0;
        }

        .btn-sm {
            padding: 6px 10px;
            font-size: 0.85em;
            margin: 0 2px;
        }

        .btn-sm i {
            font-size: 0.9em;
        }

        .btn-edit {
            background: #4CAF50;
            color: white;
        }

        .btn-edit:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #F44336;
            color: white;
        }

        .btn-danger:hover {
            background: #D32F2F;
        }

        .btn-logout {
            background: #F44336;
            color: white;
            border: 2px solid white;
        }
        .btn-logout:hover {
            background: #D32F2F;
        }

        .btn-toggle {
            background: #9C27B0;
            color: white;
        }
        .btn-toggle:hover {
            background: #7B1FA2;
        }

        .btn-download {
            background: #2196F3;
            color: white;
            padding: 4px 8px;
        }
        .btn-download:hover {
            background: #1976D2;
        }
        
        .btn-archive-toggle {
            background: #795548;
            color: white;
        }
        .btn-archive-toggle:hover {
            background: #5D4037;
        }

        .btn-help {
            background: #607D8B;
            color: white;
        }
        .btn-help:hover {
            background: #455A64;
        }

        /* ===== DASHBOARD ANALYTICS STYLES ===== */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: white;
            background: #FFA000;
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            display: block;
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
            line-height: 1;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        /* ===== LOADING STATES ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
            gap: 20px;
        }

        .loading-overlay.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FFA000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-table-row td {
            padding: 12px;
        }

        .skeleton-table-row .skeleton-loader {
            height: 20px;
            margin: 4px 0;
        }

        /* Content and Table */
        .content {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            color: #FF8F00;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box input, .search-box select {
            padding: 8px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.95em;
            min-width: 150px;
        }

        .search-box input:focus, .search-box select:focus {
            outline: none;
            border-color: #FFA000;
        }

        .table-container {
            overflow-x: auto;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        thead th {
            padding: 12px;
            text-align: left;
            color: #FF8F00;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            cursor: pointer;
        }
        
        thead th.sortable:after {
            content: '';
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 5px;
            vertical-align: middle;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 4px solid #FF8F00;
            opacity: 0.5;
            transition: transform 0.2s;
        }

        thead th.sortable.asc:after {
            transform: rotate(90deg);
            opacity: 1;
        }

        thead th.sortable.desc:after {
            transform: rotate(-90deg);
            opacity: 1;
        }

        tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
        }
        
        tbody tr.archived-row {
            background: #FAFAFA;
            color: #999;
            font-style: italic;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }
        
        tbody tr.archived-row:hover {
            background: #F0F0F0;
        }

        tbody td {
            padding: 12px;
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #FFA000;
            font-size: 1.1em;
        }

        /* Timer Styles */
        .timer {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85em;
            font-family: monospace;
        }

        .timer-normal {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .timer-warning {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .timer-urgent {
            background: #FFEBEE;
            color: #C62828;
            animation: pulse 1s infinite;
        }

        .timer-closed {
            background: #757575;
            color: white;
            font-style: italic;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Card View Styles */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .task-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #FFA000;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .task-card.free-task {
            background: #FFF3E0;
            border-left: 4px solid #FFB300;
        }

        .task-card.free-task::after {
            content: "FREE";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 4em;
            font-weight: bold;
            color: rgba(255, 179, 0, 0.1);
            pointer-events: none;
            z-index: 1;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .task-card.free-task .card-header {
            background: #FFECB3;
        }

        .card-title {
            font-weight: 600;
            color: #FF8F00;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .task-card.free-task .card-title {
            color: #FF8F00;
        }

        .card-body {
            padding: 15px;
            position: relative;
            z-index: 2;
        }

        .card-field {
            display: flex;
            margin-bottom: 10px;
            align-items: flex-start;
        }

        .card-label {
            font-weight: 600;
            color: #666;
            width: 120px;
            flex-shrink: 0;
        }

        .task-card.free-task .card-label {
            color: #FF8F00;
        }

        .card-value {
            flex-grow: 1;
            color: #333;
        }

        .task-card.free-task .card-value {
            color: #E65100;
        }

        .card-footer {
            padding: 10px 15px;
            background: #FAFAFA;
            border-top: 1px solid #EEE;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .task-card.free-task .card-footer {
            background: #FFF3E0;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }

        .modal-header {
            background: #FFA000;
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.3em;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .modal-body {
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #FF8F00;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 4px;
            font-size: 0.95em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #FFA000;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Validation Styles */
        .form-group.error input,
        .form-group.error textarea,
        .form-group.error select {
            border-color: #F44336;
            background-color: #FFEBEE;
        }

        .error-message {
            color: #F44336;
            font-size: 0.85em;
            margin-top: 5px;
            display: none;
        }

        .form-group.error .error-message {
            display: block;
        }

        /* File Upload Styles */
        #fileAttachmentsContainer {
            grid-column: 1 / -1;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 4px;
        }

        #fileAttachmentsList {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            border-radius: 4px;
            font-size: 0.9em;
            color: #2E7D32;
            max-width: 100%;
        }
        .file-item i {
            margin-right: 5px;
        }
        .file-item button {
            background: none;
            border: none;
            color: #F44336;
            margin-left: 8px;
            cursor: pointer;
            padding: 0;
            font-size: 1.1em;
        }
        .file-item-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
            display: inline-block;
        }
        .file-warning {
            color: #FF9800;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .modal-footer {
            padding: 0 25px 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .alert {
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
            animation: slideDown 0.3s;
        }

        .alert.active {
            display: block;
        }

        .alert-success {
            background: #C8E6C9;
            color: #2E7D32;
            border-left: 4px solid #4CAF50;
        }

        .alert-error {
            background: #FFCCBC;
            color: #BF360C;
            border-left: 4px solid #F57C00;
        }
        
        .alert-warning {
            background: #FFF3E0;
            color: #EF6C00;
            border-left: 4px solid #FFC107;
        }

        .delete-modal-content {
            text-align: center;
        }

        .delete-modal-content p {
            margin: 20px 0;
            color: #666;
            font-size: 1.05em;
        }

        .delete-modal-content .item-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #FFA000;
        }

        .delete-modal-content .item-info strong {
            color: #FF8F00;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .no-wrap {
            white-space: nowrap;
        }

        /* User Management List */
        #userList {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .user-card {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.2s;
        }

        .user-card:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .user-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid #FFA000;
        }

        .user-info {
            flex-grow: 1;
        }
        .user-info strong {
            display: block;
            font-size: 1.05em;
            color: #FF8F00;
        }

        .user-info small {
            color: #666;
            font-size: 0.85em;
        }

        .user-actions button {
            margin-left: 5px;
        }

        /* Print Styles */
        @media print {
            body {
                background: none;
                padding: 0;
            }
            .container, .header, .content, .table-header, .search-box, .modal, .modal-content, .alert {
                display: none !important;
            }
            .print-area {
                display: block !important;
                page-break-after: always;
            }

            /* Styles for the print content */
            .print-slip-header {
                text-align: center;
                margin-bottom: 20px;
                padding: 10px 0;
                border-bottom: 2px solid #333;
            }

            .print-slip-header h2 {
                color: #FFA000;
                margin-bottom: 5px;
            }
            
            .student-card {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 15px;
                border-radius: 4px;
                page-break-inside: avoid;
            }

            .card-number {
                font-size: 1.2em;
                font-weight: bold;
                color: #FF8F00;
                border-bottom: 1px dashed #ccc;
                padding-bottom: 5px;
                margin-bottom: 10px;
            }

            .card-row {
                display: flex;
                margin-bottom: 5px;
                font-size: 0.9em;
            }

            .card-label {
                font-weight: 600;
                width: 120px;
                color: #555;
            }

            .card-value {
                flex-grow: 1;
                color: #333;
            }

            .print-slip-footer {
                text-align: center;
                margin-top: 20px;
                padding-top: 10px;
                border-top: 1px solid #ccc;
                font-size: 0.8em;
            }
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .view-toggle button {
            padding: 8px 15px;
            border: 2px solid #FFA000;
            background: white;
            color: #FFA000;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle button.active {
            background: #FFA000;
            color: white;
        }

        .view-toggle button:hover:not(.active) {
            background: #f8f9fa;
        }

        /* Status Badge */
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-allocated {
            background: #E3F2FD;
            color: #1565C0;
        }

        .status-pending {
            background: #FFF3E0;
            color: #EF6C00;
        }

        .status-in-progress {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-completed {
            background: #C8E6C9;
            color: #388E3C;
        }
        
        .status-archived {
            background: #EFEBE9;
            color: #5D4037;
            font-style: italic;
        }

        .status-on-hold {
            background: #FFEBEE;
            color: #C62828;
        }

        .danger-zone {
            padding: 20px;
            border: 2px solid #F44336;
            border-radius: 4px;
            margin-top: 20px;
            background: #FFEBEE;
            text-align: center;
        }
        
        .danger-zone h4 {
            color: #F44336;
            margin-bottom: 10px;
        }
        
        /* Total Amount Display */
        .total-amount {
            background: #E8F5E9;
            padding: 8px 15px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
            font-weight: 600;
            color: #2E7D32;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            margin-left: auto;
        }
        
        /* File Download Button Style */
        .file-download-badge {
            display: inline-flex;
            align-items: center;
            background: #2196F3;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            text-decoration: none;
        }
        .file-download-badge:hover {
            background: #1976D2;
        }
        .file-download-badge i {
            margin-right: 5px;
        }
        
        /* Advanced Search Panel */
        .advanced-search-panel {
            background: #f8f9fa;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .advanced-search-panel.active {
            display: block;
        }
        
        .advanced-search-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .advanced-search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .bulk-actions-panel {
            background: #FFF3E0;
            border: 1px solid #FFD54F;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .bulk-actions-panel.active {
            display: block;
        }
        
        .bulk-actions-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .bulk-actions-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .bulk-actions-buttons select {
            padding: 6px 10px;
            border: 2px solid #FFD54F;
            border-radius: 4px;
            font-size: 0.85em;
            min-width: 150px;
        }
        
        .checkbox-column {
            width: 30px;
        }
        
        .checkbox-column input {
            margin: 0;
        }
        
        /* In Progress Animation */
        .in-progress-animation {
            display: inline-block;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Help & Support Modal */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message {
            background: #FFF3E0;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .admin-message {
            background: #f8f9fa;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 0.8em;
            margin-bottom: 5px;
            color: #666;
        }
        
        .chat-input {
            display: flex;
            padding: 10px;
            background: white;
            border-top: 1px solid #ddd;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }
        
        .chat-input button {
            background: #FFA000;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
        }
        
        .user-earnings {
            background: #E8F5E9;
            padding: 8px 15px;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
            font-weight: 600;
            color: #2E7D32;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
        }

        /* NEW STYLES FOR USER APPROVAL SYSTEM */
        .user-actions {
            display: flex;
            gap: 5px;
        }

        .pending-approvals {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
        }

        .pending-approvals h3 {
            color: #EF6C00;
            margin-bottom: 10px;
        }
        
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingMessage">Loading...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> Task Management System</h1>
            <div class="header-buttons">
                <button class="btn btn-add" onclick="openAddModal()"><i class="fas fa-plus"></i> Add New Task</button>
                <button class="btn btn-print" onclick="printAllCards()"><i class="fas fa-print"></i> Print All Details</button>
                <button class="btn btn-print" style="background: #4CAF50; color: white; border-color: #388E3C;" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button>
                <button class="btn btn-print" onclick="openUserModal()"><i class="fas fa-users-cog"></i> Settings</button>
                <button class="btn btn-help" onclick="openHelpModal()"><i class="fas fa-question-circle"></i> Help & Support</button>
                <button class="btn btn-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </div>

        <div class="content">
            <div id="alertBox" class="alert"></div>

            <!-- Dashboard Analytics -->
            <div class="dashboard-stats" id="dashboardStats">
                <!-- Stats will be populated by JavaScript -->
            </div>

            <!-- Advanced Search Panel -->
            <div class="advanced-search-panel" id="advancedSearchPanel">
                <div class="advanced-search-header">
                    <h3><i class="fas fa-search-plus"></i> Advanced Search</h3>
                    <button class="btn btn-sm btn-secondary" onclick="toggleAdvancedSearch()">Close</button>
                </div>
                <div class="advanced-search-filters">
                    <div class="form-group">
                        <label for="searchAssignee">Assignee</label>
                        <select id="searchAssignee" onchange="applyFilters()">
                            <option value="">All Assignees</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchStatus">Status</label>
                        <select id="searchStatus" onchange="applyFilters()">
                            <option value="">All Statuses</option>
                            <option value="Allocated">Allocated</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchPriority">Priority</label>
                        <select id="searchPriority" onchange="applyFilters()">
                            <option value="">All Priorities</option>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="searchAmountMin">Amount Min</label>
                        <input type="number" id="searchAmountMin" placeholder="Min amount" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="searchAmountMax">Amount Max</label>
                        <input type="number" id="searchAmountMax" placeholder="Max amount" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="searchDateFrom">Date From</label>
                        <input type="date" id="searchDateFrom" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="searchDateTo">Date To</label>
                        <input type="date" id="searchDateTo" onchange="applyFilters()">
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Panel -->
            <div class="bulk-actions-panel" id="bulkActionsPanel">
                <div class="bulk-actions-header">
                    <h3><i class="fas fa-layer-group"></i> Bulk Actions</h3>
                    <button class="btn btn-sm btn-secondary" onclick="toggleBulkActions()">Close</button>
                </div>
                <div class="bulk-actions-buttons">
                    <select id="bulkStatusSelect">
                        <option value="">Update Status</option>
                        <option value="Allocated">Allocated</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Archived">Archived</option>
                    </select>
                    <button class="btn btn-sm btn-primary" onclick="bulkUpdateStatus()"><i class="fas fa-sync"></i> Update Status</button>
                    
                    <select id="bulkAssigneeSelect">
                        <option value="">Update Assignee</option>
                    </select>
                    <button class="btn btn-sm btn-edit" onclick="bulkUpdateAssignee()"><i class="fas fa-user-edit"></i> Update Assignee</button>
                    
                    <button class="btn btn-sm btn-danger" onclick="bulkDeleteTasks()"><i class="fas fa-trash"></i> Delete Selected</button>
                    <button class="btn btn-sm btn-archive-toggle" id="toggleArchivedBtn" onclick="toggleArchivedView()"><i class="fas fa-eye"></i> Show Archived</button>
                </div>
            </div>

            <div class="table-header">
                <h2>
                    <span>All Tasks</span>
                </h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search tasks by name or assignee...">
                    
                    <button class="btn btn-toggle" id="toggleViewBtn" onclick="toggleView()"><i class="fas fa-th"></i> Card View</button>
                    
                    <!-- Feature Buttons -->
                    <button class="btn btn-primary" onclick="toggleAdvancedSearch()"><i class="fas fa-search-plus"></i> Advanced Search</button>
                    <button class="btn btn-primary" onclick="toggleBulkActions()"><i class="fas fa-layer-group"></i> Bulk Actions</button>
                </div>
                
                <!-- Total Amount Display -->
                <div class="total-amount" id="totalAmountDisplay">
                    <span>Project Value:</span>
                    <span id="totalAmountValue">â‚¹0.00</span>
                </div>
            </div>
            
            <div class="table-container" id="tableView">
                <table id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="20" class="loading">Loading items...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card-container" id="cardView" style="display: none;"></div>
        </div>
    </div>
    
    <div class="print-area" style="display: none;">
        <div id="printContent"></div>
    </div>

    <!-- Existing Modals -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Task</h2>
                <button class="close-btn" onclick="closeFormModal()">&times;</button>
            </div>
            <form id="itemForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="editId">
                <div class="modal-body" id="formFields">
                    </div>
                
                <div class="modal-body" style="grid-template-columns: 1fr; padding-top: 0;">
                    <div id="fileAttachmentsContainer">
                        <div class="form-group" style="margin-bottom: 10px;">
                            <label for="fileAttachmentsInput"><i class="fas fa-paperclip"></i> File Attachments (Max 3 files, .xlsx, .pdf, .jpg only)</label>
                            <input type="file" id="fileAttachmentsInput" multiple accept=".xlsx,.pdf,.jpg,.jpeg" onchange="handleFileSelection(event)">
                            <div class="file-warning" id="fileWarning"></div>
                        </div>
                        <ul id="fileAttachmentsList">
                            </ul>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeFormModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="userManagementModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2><i class="fas fa-users-cog"></i> User Management (Assignees)</h2>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="modal-body" style="grid-template-columns: 1fr;">

                <!-- User Approval Section -->
                <div class="pending-approvals" style="border: 2px solid #FF9800; padding: 15px; border-radius: 4px; margin: 15px 0;">
                    <h3><i class="fas fa-clock"></i> Pending User Approvals</h3>
                    <div id="pendingUsersList"></div>
                </div>

                <!-- Add New User Form (for Admin) -->
                <div class="card" style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                    <h3><i class="fas fa-user-plus"></i> Add New User (Admin)</h3>
                    <form id="userForm" onsubmit="handleUserSubmit(event)" style="margin-top: 15px;">
                        <input type="hidden" id="userEditId">
                        <div class="modal-body" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); padding: 0;">
                            <div class="form-group">
                                <label for="userName"><i class="fas fa-user"></i> Name</label>
                                <input type="text" id="userName" required placeholder="Enter user full name">
                            </div>
                            <div class="form-group">
                                <label for="userEmail"><i class="fas fa-envelope"></i> Email</label>
                                <input type="email" id="userEmail" required placeholder="Enter email">
                            </div>
                            <div class="form-group">
                                <label for="userPassword"><i class="fas fa-lock"></i> Password</label>
                                <input type="password" id="userPassword" required placeholder="Set password">
                            </div>
                            <div class="form-group">
                                <label for="userPhone"><i class="fas fa-phone"></i> Phone</label>
                                <input type="tel" id="userPhone" placeholder="Phone number">
                            </div>
                            <div class="form-group" style="align-self: flex-end;">
                                <button type="submit" class="btn btn-primary" id="userSubmitBtn" style="width: 100%;">
                                    <i class="fas fa-save"></i> Save User
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <h3><i class="fas fa-list"></i> Approved Users</h3>
                <div id="userEarningsInfo" style="margin-bottom: 15px;"></div>
                <ul id="userList"></ul>
                
                <div class="danger-zone">
                    <h4>DANGER ZONE</h4>
                    <p>Permanently delete all tasks and user data from this browser's local storage.</p>
                    <button class="btn btn-danger" onclick="clearAllData()"><i class="fas fa-radiation"></i> Clear All Task & User Data</button>
                </div>

            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body delete-modal-content">
                <p>Are you sure you want to delete this task?</p>
                <div class="item-info" id="deleteItemInfo"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <div id="userDeleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm User Delete</h2>
                <button class="close-btn" onclick="closeUserDeleteModal()">&times;</button>
            </div>
            <div class="modal-body delete-modal-content">
                <p>Are you sure you want to delete user: <strong id="userToDeleteName"></strong>?</p>
                <small style="color: red;">Warning: Tasks assigned to this user will remain linked until edited.</small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserDeleteModal()">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmUserDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-question-circle"></i> Help & Support Center</h2>
                <button class="close-btn" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body" style="grid-template-columns: 1fr;">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message admin-message">
                            <div class="message-sender">Admin</div>
                            <div>Hello! How can I help you today?</div>
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type your message...">
                        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW MODALS FOR USER APPROVAL SYSTEM -->
    <!-- User Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2><i class="fas fa-sign-in-alt"></i> User Login</h2>
                <button class="close-btn" onclick="closeLoginModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="loginForm" onsubmit="handleUserLogin(event)">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required placeholder="Your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required placeholder="Your password">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                    <p style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="openSignupModal()">Create new account</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <!-- User Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2><i class="fas fa-user-plus"></i> User Signup</h2>
                <button class="close-btn" onclick="closeSignupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="signupForm" onsubmit="handleSignup(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="signupName">Full Name</label>
                            <input type="text" id="signupName" required placeholder="Your full name">
                        </div>
                        <div class="form-group">
                            <label for="signupEmail">Email</label>
                            <input type="email" id="signupEmail" required placeholder="Your email">
                        </div>
                        <div class="form-group">
                            <label for="signupPhone">Phone Number</label>
                            <input type="tel" id="signupPhone" required placeholder="Your phone number">
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" required placeholder="Create password">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ===== USER APPROVAL SYSTEM =====
        class UserApprovalSystem {
            constructor() {
                this.pendingUsers = JSON.parse(localStorage.getItem('pendingUsers')) || [];
                this.approvedUsers = JSON.parse(localStorage.getItem('approvedUsers')) || [];
                this.currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
            }

            // User signup
            signupUser(userData) {
                const newUser = {
                    id: `pending-${Date.now()}`,
                    name: userData.name,
                    email: userData.email,
                    phone: userData.phone,
                    password: userData.password,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    approvedAt: null,
                    approvedBy: null
                };

                this.pendingUsers.push(newUser);
                this.saveToLocalStorage();
                return newUser;
            }

            // Approve user
            approveUser(userId, approvedBy = 'Admin') {
                const userIndex = this.pendingUsers.findIndex(u => u.id === userId);
                if (userIndex === -1) return false;

                const user = this.pendingUsers[userIndex];
                user.status = 'approved';
                user.approvedAt = new Date().toISOString();
                user.approvedBy = approvedBy;

                // Move to approved users
                this.approvedUsers.push(user);
                this.pendingUsers.splice(userIndex, 1);
                
                this.saveToLocalStorage();
                return true;
            }

            // Reject user
            rejectUser(userId) {
                const userIndex = this.pendingUsers.findIndex(u => u.id === userId);
                if (userIndex === -1) return false;

                this.pendingUsers.splice(userIndex, 1);
                this.saveToLocalStorage();
                return true;
            }

            // Login verification
            verifyLogin(email, password) {
                const user = this.approvedUsers.find(u => 
                    u.email === email && u.password === password
                );
                return user || null;
            }

            // Admin login (bypass approval)
            adminLogin(email, password) {
                // Hardcoded admin credentials - you can change these
                if (email === 'admin@task.com' && password === 'admin123') {
                    return {
                        id: 'admin',
                        name: 'System Administrator',
                        email: 'admin@task.com',
                        role: 'admin',
                        status: 'approved'
                    };
                }
                return null;
            }

            saveToLocalStorage() {
                localStorage.setItem('pendingUsers', JSON.stringify(this.pendingUsers));
                localStorage.setItem('approvedUsers', JSON.stringify(this.approvedUsers));
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            }

            getPendingUsers() {
                return this.pendingUsers.filter(u => u.status === 'pending');
            }

            getApprovedUsers() {
                return this.approvedUsers;
            }

            setCurrentUser(user) {
                this.currentUser = user;
                this.saveToLocalStorage();
            }

            logout() {
                this.currentUser = null;
                localStorage.removeItem('currentUser');
            }

            isAdmin() {
                return this.currentUser && this.currentUser.role === 'admin';
            }

            isLoggedIn() {
                return this.currentUser !== null;
            }
        }

        // Initialize User Approval System
        const userApprovalSystem = new UserApprovalSystem();

        // Task Fields Definition
        const FIELDS = [
            { id: 'taskIdNumber', label: 'Task No.', type: 'text', icon: 'fa-hashtag', required: false, showInTable: true, showInPrint: true, searchable: true, placeholder: 'TSK-00001', sortable: true },
            { id: 'taskName', label: 'Task Name', type: 'text', icon: 'fa-clipboard-list', required: true, showInTable: true, showInPrint: true, searchable: true, placeholder: 'Enter task name', sortable: true },
            { id: 'assignedTo', label: 'Assigned To', type: 'select', icon: 'fa-user-tag', required: true, showInTable: true, showInPrint: true, searchable: true, placeholder: 'Select assignee', sortable: true },
            { id: 'dueDate', label: 'Due Date', type: 'date', icon: 'fa-calendar-alt', required: true, showInTable: true, showInPrint: true, searchable: false, placeholder: 'Select due date', sortable: true },
            { id: 'priority', label: 'Priority', type: 'select', icon: 'fa-exclamation-triangle', required: true, showInTable: true, showInPrint: true, searchable: true, options: ['High', 'Medium', 'Low'], sortable: true },
            { id: 'status', label: 'Status', type: 'select', icon: 'fa-info-circle', required: true, showInTable: true, showInPrint: true, searchable: true, options: ['Allocated', 'In Progress', 'Completed', 'On Hold', 'Archived'], sortable: true },
            { id: 'changesRequired', label: 'Changes Required', type: 'text', icon: 'fa-edit', required: false, showInTable: true, showInPrint: true, searchable: true, placeholder: 'Enter changes required' },
            { id: 'fileAttachments', label: 'Files', type: 'files', icon: 'fa-paperclip', required: false, showInTable: true, showInPrint: true, searchable: false, sortable: false },
            { id: 'taskAmount', label: 'Task Amount', type: 'number', icon: 'fa-dollar-sign', required: false, showInTable: true, showInPrint: true, searchable: false, placeholder: 'Enter task amount (0 for free)', step: '0.01', sortable: true }
        ];

        let allItems = [];
        let allUsers = [];
        let deleteItemId = null;
        let deleteUserId = null;
        let isCardView = false;
        let showArchived = false; 
        let timerInterval = null;
        let currentSort = { key: 'taskName', direction: 'asc' };
        
        let currentAttachments = [];
        let selectedTasks = new Set();

        // Modal and Element references
        const formModal = document.getElementById('formModal');
        const deleteModal = document.getElementById('deleteModal');
        const userManagementModal = document.getElementById('userManagementModal');
        const userDeleteModal = document.getElementById('userDeleteModal');
        const helpModal = document.getElementById('helpModal');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const itemForm = document.getElementById('itemForm');
        const userForm = document.getElementById('userForm');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const tableBody = document.getElementById('tableBody');
        const tableHead = document.getElementById('tableHead');
        const searchInput = document.getElementById('searchInput');
        const alertBox = document.getElementById('alertBox');
        const userListElement = document.getElementById('userList');
        const pendingUsersList = document.getElementById('pendingUsersList');
        const tableView = document.getElementById('tableView');
        const cardView = document.getElementById('cardView');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const totalAmountValue = document.getElementById('totalAmountValue');
        const fileAttachmentsInput = document.getElementById('fileAttachmentsInput');
        const fileAttachmentsList = document.getElementById('fileAttachmentsList');
        const fileWarning = document.getElementById('fileWarning');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingMessage = document.getElementById('loadingMessage');
        const dashboardStats = document.getElementById('dashboardStats');
        const userEarningsInfo = document.getElementById('userEarningsInfo');
        const toggleArchivedBtn = document.getElementById('toggleArchivedBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        
        // Advanced Search Elements
        const advancedSearchPanel = document.getElementById('advancedSearchPanel');
        const bulkActionsPanel = document.getElementById('bulkActionsPanel');
        const searchAssignee = document.getElementById('searchAssignee');
        const searchStatus = document.getElementById('searchStatus');
        const searchPriority = document.getElementById('searchPriority');
        const searchAmountMin = document.getElementById('searchAmountMin');
        const searchAmountMax = document.getElementById('searchAmountMax');
        const searchDateFrom = document.getElementById('searchDateFrom');
        const searchDateTo = document.getElementById('searchDateTo');
        
        // Bulk Actions Elements
        const bulkStatusSelect = document.getElementById('bulkStatusSelect');
        const bulkAssigneeSelect = document.getElementById('bulkAssigneeSelect');

        // ===== MODAL FUNCTIONS =====
        function openLoginModal() {
            loginModal.classList.add('active');
        }

        function closeLoginModal() {
            loginModal.classList.remove('active');
            loginForm.reset();
        }

        function openSignupModal() {
            closeLoginModal();
            signupModal.classList.add('active');
        }

        function closeSignupModal() {
            signupModal.classList.remove('active');
            signupForm.reset();
        }

        // ===== SIGNUP HANDLER =====
        function handleSignup(e) {
            e.preventDefault();
            
            const userData = {
                name: document.getElementById('signupName').value,
                email: document.getElementById('signupEmail').value,
                phone: document.getElementById('signupPhone').value,
                password: document.getElementById('signupPassword').value
            };

            // Check if email already exists
            const allUsers = [...userApprovalSystem.pendingUsers, ...userApprovalSystem.approvedUsers];
            if (allUsers.some(u => u.email === userData.email)) {
                showAlert('This email is already registered!', 'error');
                return;
            }

            const newUser = userApprovalSystem.signupUser(userData);
            
            document.getElementById('signupForm').reset();
            closeSignupModal();
            
            showAlert(`Registration successful! Wait for admin approval.`, 'success');
            renderPendingUsers();
        }

        // ===== LOGIN HANDLER =====
        function handleUserLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            // Try admin login first
            let user = userApprovalSystem.adminLogin(email, password);
            
            // If not admin, try regular user login
            if (!user) {
                user = userApprovalSystem.verifyLogin(email, password);
            }
            
            if (user) {
                userApprovalSystem.setCurrentUser(user);
                showAlert(`Welcome ${user.name}!`, 'success');
                closeLoginModal();
                
                // Update UI based on user role
                updateUIForUser();
                loadItems(); // Reload tasks based on user permissions
            } else {
                showAlert('Invalid email or password', 'error');
            }
        }

        // ===== USER INTERFACE UPDATES =====
        function updateUIForUser() {
            const user = userApprovalSystem.currentUser;
            const isAdmin = userApprovalSystem.isAdmin();
            
            // Show/hide admin features
            const adminButtons = document.querySelectorAll('.btn-add, .btn-print, .btn-help');
            const userManagementBtn = document.querySelector('[onclick="openUserModal()"]');
            
            if (isAdmin) {
                // Show all admin features
                adminButtons.forEach(btn => btn.style.display = 'inline-block');
                if (userManagementBtn) userManagementBtn.style.display = 'inline-block';
                
                // Update header to show admin status
                document.querySelector('.header h1').innerHTML = 
                    '<i class="fas fa-tasks"></i> Task Management System <small style="font-size: 0.6em; color: #FFD700;">(Admin Mode)</small>';
            } else {
                // Hide admin features for regular users
                adminButtons.forEach(btn => btn.style.display = 'none');
                if (userManagementBtn) userManagementBtn.style.display = 'none';
                
                // Update header for user mode
                document.querySelector('.header h1').innerHTML = 
                    `<i class="fas fa-tasks"></i> Task Management System <small style="font-size: 0.6em;">(User: ${user.name})</small>`;
            }
        }

        // ===== PENDING USERS DISPLAY =====
        function renderPendingUsers() {
            const pendingUsers = userApprovalSystem.getPendingUsers();

            if (pendingUsers.length === 0) {
                pendingUsersList.innerHTML = '<p style="text-align: center; color: #999;">No pending user approvals</p>';
                return;
            }

            pendingUsersList.innerHTML = pendingUsers.map(user => `
                <div class="user-card" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #ddd; margin: 5px 0; border-radius: 4px;">
                    <div>
                        <strong>${user.name}</strong><br>
                        <small>${user.email} | ${user.phone}</small><br>
                        <small style="color: #FF9800;">Registered: ${new Date(user.createdAt).toLocaleDateString('en-IN')}</small>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-edit" onclick="approveUser('${user.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="rejectUser('${user.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function approveUser(userId) {
            if (confirm('Approve this user?')) {
                if (userApprovalSystem.approveUser(userId)) {
                    showAlert('User approved successfully!', 'success');
                    renderPendingUsers();
                    loadUsers(); // Refresh user list
                }
            }
        }

        function rejectUser(userId) {
            if (confirm('Reject this user?')) {
                if (userApprovalSystem.rejectUser(userId)) {
                    showAlert('User rejected', 'warning');
                    renderPendingUsers();
                }
            }
        }

        // ===== LOADING STATES FUNCTIONS =====
        function showLoading(message = 'Loading...') {
            loadingMessage.textContent = message;
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        // ===== DASHBOARD ANALYTICS FUNCTIONS =====
        function updateDashboardStats() {
            const totalTasks = allItems.length;
            const completedTasks = allItems.filter(t => t.status === 'Completed').length;
            const inProgressTasks = allItems.filter(t => t.status === 'In Progress').length;
            const highPriorityTasks = allItems.filter(t => t.priority === 'High').length;
            const allocatedTasks = allItems.filter(t => t.status === 'Allocated').length;
            const freeTasks = allItems.filter(t => !t.taskAmount || t.taskAmount === 0).length;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-icon" style="background: #FFA000;">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">${totalTasks}</span>
                        <span class="stat-label">Total Tasks</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #4CAF50;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">${completedTasks}</span>
                        <span class="stat-label">Completed</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #FF9800;">
                        <i class="fas fa-spinner ${inProgressTasks > 0 ? 'in-progress-animation' : ''}"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">${inProgressTasks}</span>
                        <span class="stat-label">In Progress</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #9C27B0;">
                        <i class="fas fa-flag"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">${highPriorityTasks}</span>
                        <span class="stat-label">High Priority</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #2196F3;">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">${allocatedTasks}</span>
                        <span class="stat-label">Allocated</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #00BCD4;">
                        <i class="fas fa-gift"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value">${freeTasks}</span>
                        <span class="stat-label">Free Tasks</span>
                    </div>
                </div>
            `;
            
            dashboardStats.innerHTML = statsHTML;
        }

        // ===== VALIDATION FUNCTIONS =====
        function validateTaskData(item) {
            const errors = [];
            
            if (!item.taskName?.trim()) {
                errors.push({ field: 'taskName', message: 'Task name is required' });
            } else if (item.taskName.length < 3) {
                errors.push({ field: 'taskName', message: 'Task name must be at least 3 characters' });
            }

            if (!item.assignedTo) {
                errors.push({ field: 'assignedTo', message: 'Assignee is required' });
            }

            if (!item.dueDate) {
                errors.push({ field: 'dueDate', message: 'Due date is required' });
            } else if (new Date(item.dueDate) < new Date().setHours(0,0,0,0)) {
                errors.push({ field: 'dueDate', message: 'Due date cannot be in the past' });
            }

            if (item.taskAmount && item.taskAmount < 0) {
                errors.push({ field: 'taskAmount', message: 'Task amount cannot be negative' });
            } else if (item.taskAmount > 1000000) {
                errors.push({ field: 'taskAmount', message: 'Task amount cannot exceed â‚¹1,000,000' });
            }

            if (!item.priority) {
                errors.push({ field: 'priority', message: 'Priority is required' });
            }

            if (!item.status) {
                errors.push({ field: 'status', message: 'Status is required' });
            }

            return errors;
        }

        function showFieldErrors(errors) {
            document.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('error');
            });

            errors.forEach(error => {
                const field = document.getElementById(error.field);
                if (field) {
                    const formGroup = field.closest('.form-group');
                    if (formGroup) {
                        formGroup.classList.add('error');
                        let errorElement = formGroup.querySelector('.error-message');
                        if (!errorElement) {
                            errorElement = document.createElement('div');
                            errorElement.className = 'error-message';
                            formGroup.appendChild(errorElement);
                        }
                        errorElement.textContent = error.message;
                    }
                }
            });
        }

        function clearFieldErrors() {
            document.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('error');
            });
        }

        // ===== KEYBOARD SHORTCUTS =====
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    if (!formModal.classList.contains('active')) {
                        openAddModal();
                    }
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }
                
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    exportToExcel();
                }
                
                if (e.key === 'Escape') {
                    closeAllModals();
                }

                if ((e.ctrlKey || e.metaKey) && e.key === '/') {
                    e.preventDefault();
                    showKeyboardShortcutsHelp();
                }
            });

            const addButton = document.querySelector('.btn-add');
            if (addButton) {
                addButton.title = 'Add New Task (Ctrl+N)';
            }
            
            if (searchInput) {
                searchInput.placeholder = 'Search tasks (Ctrl+F)...';
            }
        }

        function showKeyboardShortcutsHelp() {
            const shortcuts = [
                { key: 'Ctrl+N', action: 'Add New Task' },
                { key: 'Ctrl+F', action: 'Focus Search' },
                { key: 'Ctrl+E', action: 'Export to Excel' },
                { key: 'Escape', action: 'Close Modals' },
                { key: 'Ctrl+/', action: 'Show this help' }
            ];

            const helpHTML = shortcuts.map(shortcut => 
                `<div style="display: flex; justify-content: space-between; margin: 8px 0;">
                    <kbd style="background: #f4f4f4; padding: 4px 8px; border-radius: 4px; border: 1px solid #ddd;">${shortcut.key}</kbd>
                    <span>${shortcut.action}</span>
                </div>`
            ).join('');

            showAlert(`<strong>Keyboard Shortcuts:</strong><br>${helpHTML}`, 'warning', 5000);
        }

        function closeAllModals() {
            closeFormModal();
            closeDeleteModal();
            closeUserModal();
            closeUserDeleteModal();
            closeHelpModal();
            closeLoginModal();
            closeSignupModal();
        }

        // --- CORE LOCAL STORAGE FUNCTIONS ---

        function getItems(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function saveItems(key, items) {
            localStorage.setItem(key, JSON.stringify(items));
        }

        function initializeData() {
            if (!localStorage.getItem('taskData')) {
                saveItems('taskData', []);
            }
            if (!localStorage.getItem('users')) {
                const defaultUsers = [
                    { id: 'user-1', name: 'Alice Johnson', email: 'alice@example.com', image: '', createdAt: new Date().toISOString() },
                    { id: 'user-2', name: 'Bob Smith', email: 'bob@example.com', image: '', createdAt: new Date().toISOString() }
                ];
                saveItems('users', defaultUsers);
            }
            if (!localStorage.getItem('taskCounter')) {
                localStorage.setItem('taskCounter', 0);
            }
        }
        
        // --- TASK NUMBERING FUNCTION ---
        const MAX_TASK_COUNT = 10000;
        
        function generateTaskId() {
            let counter = parseInt(localStorage.getItem('taskCounter') || 0);
            
            if (counter >= MAX_TASK_COUNT) {
                showAlert(`Max task limit (TSK-10000) reached!`, 'error');
                return null;
            }
            
            counter += 1;
            localStorage.setItem('taskCounter', counter);
            
            const paddedNumber = String(counter).padStart(5, '0');
            return `TSK-${paddedNumber}`;
        }
        
        function getTaskNumberForSorting(taskIdNumber) {
            if (!taskIdNumber || !taskIdNumber.startsWith('TSK-')) return 0;
            return parseInt(taskIdNumber.substring(4));
        }
        
        // --- USER MANAGEMENT & SETTINGS FUNCTIONS ---

        window.openUserModal = function() {
             userManagementModal.classList.add('active');
             updateUserEarningsInfo();
             renderPendingUsers();
        }
        
        window.closeUserModal = function() {
            userManagementModal.classList.remove('active');
            userForm.reset();
            document.getElementById('userEditId').value = '';
            document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save"></i> Save User';
            clearFieldErrors();
        }
        
        function loadUsers() {
            allUsers = userApprovalSystem.getApprovedUsers();
            renderUserList();
            generateFormFields();
            populateAssigneeFilters();
            populateBulkAssigneeSelect();
        }
        
        function updateUserEarningsInfo() {
            const userEarnings = {};
            
            // Calculate earnings for each user
            allItems.forEach(item => {
                if (item.status === 'Completed' && item.assignedTo) {
                    const amount = parseFloat(item.taskAmount) || 0;
                    if (!userEarnings[item.assignedTo]) {
                        userEarnings[item.assignedTo] = 0;
                    }
                    userEarnings[item.assignedTo] += amount;
                }
            });
            
            let earningsHTML = '';
            userApprovalSystem.getApprovedUsers().forEach(user => {
                const earnings = userEarnings[user.name] || 0;
                earningsHTML += `
                    <div class="user-earnings">
                        <span>${escapeHtml(user.name)}:</span>
                        <span>${formatCurrency(earnings)}</span>
                    </div>
                `;
            });
            
            userEarningsInfo.innerHTML = earningsHTML || '<p>No earnings data available.</p>';
        }
        
        window.clearAllData = function() {
            if (confirm("ðŸš¨ DANGER ZONE! Are you ABSOLUTELY sure you want to delete ALL task and user data? This action is irreversible.")) {
                showLoading('Clearing all data...');
                setTimeout(() => {
                    localStorage.removeItem('taskData');
                    localStorage.removeItem('users');
                    localStorage.removeItem('taskCounter');
                    localStorage.removeItem('selectedTheme');
                    localStorage.removeItem('pendingUsers');
                    localStorage.removeItem('approvedUsers');
                    localStorage.removeItem('currentUser');
                    hideLoading();
                    showAlert('All data cleared successfully!', 'success');
                    setTimeout(() => {
                        window.location.reload(); 
                    }, 500);
                }, 1000);
            }
        }
        
        function renderUserList() {
            userListElement.innerHTML = '';
            const approvedUsers = userApprovalSystem.getApprovedUsers();
            
            if (approvedUsers.length === 0) {
                userListElement.innerHTML = '<p style="text-align: center; color: #999;">No users added yet.</p>';
                return;
            }

            approvedUsers.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-card';
                const defaultImage = "https://via.placeholder.com/50?text=ðŸ‘¤";
                
                li.innerHTML = `
                    <img src="${user.image || defaultImage}" alt="${user.name}" class="user-image">
                    <div class="user-info">
                        <strong>${escapeHtml(user.name)}</strong>
                        <small>${escapeHtml(user.email || 'No email')}</small>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-edit" onclick="openUserEditModal('${user.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="openUserDeleteModal('${user.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                userListElement.appendChild(li);
            });
        }
        
        function handleUserSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('userEditId').value;
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const phone = document.getElementById('userPhone').value.trim();

            const user = { name, email, password, phone };

            if (id) {
                // Update existing user
                const index = userApprovalSystem.approvedUsers.findIndex(u => u.id === id);
                if (index !== -1) {
                    userApprovalSystem.approvedUsers[index] = { ...userApprovalSystem.approvedUsers[index], ...user };
                    userApprovalSystem.saveToLocalStorage();
                    showAlert('User updated successfully!', 'success');
                }
            } else {
                // Add new user (auto-approved when added by admin)
                user.id = `user-${Date.now()}`;
                user.status = 'approved';
                user.approvedAt = new Date().toISOString();
                user.approvedBy = 'Admin';
                user.createdAt = new Date().toISOString();
                
                userApprovalSystem.approvedUsers.push(user);
                userApprovalSystem.saveToLocalStorage();
                showAlert('User added successfully!', 'success');
            }

            document.getElementById('userForm').reset();
            document.getElementById('userEditId').value = '';
            document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-save"></i> Save User';
            loadUsers();
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        window.openUserEditModal = function(id) {
            const user = userApprovalSystem.approvedUsers.find(u => u.id === id);
            if (!user) return;

            document.getElementById('userEditId').value = id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').value = user.password || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userSubmitBtn').innerHTML = '<i class="fas fa-sync"></i> Update User';
        }

        window.openUserDeleteModal = function(id) {
            const user = userApprovalSystem.approvedUsers.find(u => u.id === id);
            if (!user) return;
            deleteUserId = id;
            document.getElementById('userToDeleteName').textContent = user.name;
            userDeleteModal.classList.add('active');
        }

        window.closeUserDeleteModal = function() {
            userDeleteModal.classList.remove('active');
            deleteUserId = null;
        }

        document.getElementById('confirmUserDeleteBtn').addEventListener('click', () => {
            if (!deleteUserId) return;

            showLoading('Deleting user...');
            setTimeout(() => {
                const initialLength = userApprovalSystem.approvedUsers.length;
                userApprovalSystem.approvedUsers = userApprovalSystem.approvedUsers.filter(u => u.id !== deleteUserId);
                userApprovalSystem.saveToLocalStorage();

                if (userApprovalSystem.approvedUsers.length !== initialLength) {
                    showAlert('User deleted successfully!', 'success');
                    loadUsers();
                } else {
                    showAlert('Error: Could not delete user', 'error');
                }
                hideLoading();
                closeUserDeleteModal();
            }, 500);
        });


        // --- TASK FORM GENERATION ---

        function generateFormFields() {
            const formFields = document.getElementById('formFields');
            const fieldsToRender = FIELDS.filter(f => f.id !== 'taskIdNumber' && f.id !== 'fileAttachments'); 
            
            formFields.innerHTML = fieldsToRender.map(field => {
                const icon = field.icon ? `<i class="fas ${field.icon}"></i> ` : '';
                const required = field.required ? 'required' : '';
                const placeholder = field.placeholder ? `placeholder="${field.placeholder}"` : '';
                const step = field.step ? `step="${field.step}"` : '';
                
                let extraAttributes = '';
                
                if (field.id === 'dueDate') {
                    const today = new Date().toISOString().split('T')[0];
                    extraAttributes = `min="${today}"`; 
                }
                
                if (field.id === 'assignedTo') {
                    const assigneeOptions = userApprovalSystem.getApprovedUsers().map(user => 
                        `<option value="${escapeHtml(user.name)}">${escapeHtml(user.name)}</option>`
                    ).join('');

                    return `
                        <div class="form-group">
                            <label for="${field.id}">${icon}${field.label}</label>
                            <select id="${field.id}" ${required}>
                                <option value="">Select Assignee</option>
                                ${assigneeOptions}
                            </select>
                            <div class="error-message" id="${field.id}Error"></div>
                        </div>
                    `;

                } else if (field.type === 'select') {
                    const options = field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                    return `
                        <div class="form-group">
                            <label for="${field.id}">${icon}${field.label}</label>
                            <select id="${field.id}" ${required}>
                                <option value="">Select ${field.label.toLowerCase()}</option>
                                ${options}
                            </select>
                            <div class="error-message" id="${field.id}Error"></div>
                        </div>
                    `;
                } else if (field.type === 'textarea') {
                    return `
                        <div class="form-group">
                            <label for="${field.id}">${icon}${field.label}</label>
                            <textarea id="${field.id}" ${required} ${placeholder}></textarea>
                            <div class="error-message" id="${field.id}Error"></div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="form-group">
                            <label for="${field.id}">${icon}${field.label}</label>
                            <input type="${field.type}" id="${field.id}" ${required} ${placeholder} ${step} ${extraAttributes}>
                            <div class="error-message" id="${field.id}Error"></div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Sorting Logic 
        window.sortTable = function(key) {
            let direction = 'asc';

            if (currentSort.key === key) {
                direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            }

            currentSort = { key, direction };
            
            generateTableHeader();
            applyFilters();
        }

        function generateTableHeader() {
            const visibleFields = FIELDS.filter(f => f.showInTable);
            
            const orderedFields = [
                'taskIdNumber', 'taskName', 'assignedTo', 'changesRequired', 'fileAttachments', 'taskAmount', 
                'priority', 'status', 'dueDate'
            ].map(id => visibleFields.find(f => f.id === id)).filter(f => f !== undefined);
            
            const headers = [
                { label: '', id: 'checkbox', sortable: false },
                ...orderedFields.map(f => ({ 
                    label: f.label, 
                    id: f.id, 
                    sortable: f.sortable || false 
                })),
                { label: 'Created Date', id: 'createdAt', sortable: true },
                { label: 'Closing Time', id: 'timeRemaining', sortable: true }
            ];
            
            tableHead.innerHTML = `<tr>${headers.map(h => {
                const sortClass = h.sortable ? 'sortable' : '';
                const activeSortClass = (h.id === currentSort.key) ? currentSort.direction : '';
                const onClick = h.sortable ? `onclick="sortTable('${h.id}')"` : '';
                
                return `<th class="${sortClass} ${activeSortClass}" ${onClick}>${h.label}</th>`;
            }).join('')}</tr>`;
        }
        
        // --- FILE ATTACHMENT FUNCTIONS ---
        const MAX_FILE_COUNT = 3;
        const MAX_TOTAL_SIZE = 15 * 1024 * 1024;

        function renderFileAttachmentsList() {
            fileAttachmentsList.innerHTML = '';
            let totalSize = 0;
            
            currentAttachments.forEach((file, index) => {
                totalSize += file.size || 0;
                
                const icon = getFileIcon(file.name);
                const li = document.createElement('li');
                li.className = 'file-item';
                
                li.innerHTML = `
                    <i class="${icon}"></i>
                    <span class="file-item-name" title="${escapeHtml(file.name)}">${escapeHtml(file.name)}</span>
                    <button type="button" onclick="deleteFileAttachment(${index})"><i class="fas fa-times-circle"></i></button>
                `;
                fileAttachmentsList.appendChild(li);
            });
            
            fileWarning.textContent = '';
            if (currentAttachments.length > MAX_FILE_COUNT) {
                fileWarning.textContent = `Error: Maximum ${MAX_FILE_COUNT} files allowed.`;
            } else if (totalSize > MAX_TOTAL_SIZE) {
                const currentSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                const maxSizeMB = (MAX_TOTAL_SIZE / (1024 * 1024));
                fileWarning.textContent = `Error: Total file size (${currentSizeMB}MB) exceeds maximum ${maxSizeMB}MB.`;
            } else if (currentAttachments.length > 0) {
                 const currentSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                 fileWarning.textContent = `Total size: ${currentSizeMB}MB / 15MB`;
            }
        }
        
        function getFileIcon(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            if (ext === 'xlsx') return 'fas fa-file-excel';
            if (ext === 'pdf') return 'fas fa-file-pdf';
            if (ext === 'jpg' || ext === 'jpeg') return 'fas fa-file-image';
            return 'fas fa-file';
        }
        
        window.deleteFileAttachment = function(index) {
            currentAttachments.splice(index, 1);
            fileAttachmentsInput.value = '';
            renderFileAttachmentsList();
        }

        window.handleFileSelection = function(e) {
            const files = Array.from(e.target.files);
            const totalFiles = currentAttachments.length + files.length;
            const validExtensions = ['xlsx', 'pdf', 'jpg', 'jpeg'];
            const newAttachments = [];
            let newTotalSize = currentAttachments.reduce((sum, file) => sum + (file.size || 0), 0);

            if (totalFiles > MAX_FILE_COUNT) {
                e.target.value = '';
                showAlert(`You can upload a maximum of ${MAX_FILE_COUNT} files per task.`, 'error');
                renderFileAttachmentsList();
                return;
            }

            const processFiles = (fileIndex = 0) => {
                if (fileIndex >= files.length) {
                    currentAttachments.push(...newAttachments);
                    renderFileAttachmentsList();
                    e.target.value = ''; 
                    return;
                }

                const file = files[fileIndex];
                const ext = file.name.split('.').pop().toLowerCase();

                if (!validExtensions.includes(ext)) {
                    showAlert(`File type not allowed: ${file.name}. Only .xlsx, .pdf, and .jpg are permitted.`, 'error');
                    e.target.value = '';
                    renderFileAttachmentsList();
                    return;
                }
                
                newTotalSize += file.size;

                if (newTotalSize > MAX_TOTAL_SIZE) {
                    showAlert(`File selection canceled. Total size exceeds 15MB limit.`, 'error');
                    e.target.value = '';
                    renderFileAttachmentsList();
                    return;
                }

                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    newAttachments.push({
                        name: file.name,
                        data: readerEvent.target.result,
                        size: file.size,
                        type: file.type
                    });
                    processFiles(fileIndex + 1);
                };
                reader.readAsDataURL(file);
            };

            processFiles();
        }
        
        window.downloadAttachment = function(itemId, fileIndex) {
            const item = allItems.find(i => i.id === itemId);
            if (!item || !item.fileAttachments || !item.fileAttachments[fileIndex]) return;
            
            const file = item.fileAttachments[fileIndex];
            
            const dataParts = file.data.split(',');
            const base64Data = dataParts.length > 1 ? dataParts[1] : file.data;
            const mimeTypeMatch = file.data.match(/^data:([a-z0-9\/\-\.]+);base64,/i);
            const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : file.type;

            const byteCharacters = atob(base64Data);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                const slice = byteCharacters.slice(offset, offset + 512);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            
            const blob = new Blob(byteArrays, { type: mimeType });
            saveAs(blob, file.name);
        }
        
        window.downloadAllAttachments = async function(itemId) {
            const item = allItems.find(i => i.id === itemId);
            if (!item || !item.fileAttachments || item.fileAttachments.length === 0) {
                showAlert('No files attached to this task.', 'error');
                return;
            }

            showAlert(`Downloading ${item.fileAttachments.length} file(s)... This may take a moment.`, 'warning');

            for (let i = 0; i < item.fileAttachments.length; i++) {
                const file = item.fileAttachments[i];
                
                await new Promise(resolve => setTimeout(resolve, 500 * (i === 0 ? 0 : 1))); 
                
                try {
                    const dataParts = file.data.split(',');
                    const base64Data = dataParts.length > 1 ? dataParts[1] : file.data;
                    const mimeTypeMatch = file.data.match(/^data:([a-z0-9\/\-\.]+);base64,/i);
                    const mimeType = mimeTypeMatch ? mimeTypeMatch[1] : file.type;

                    const byteCharacters = atob(base64Data);
                    const byteArrays = [];

                    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                        const slice = byteCharacters.slice(offset, offset + 512);
                        const byteNumbers = new Array(slice.length);
                        for (let j = 0; j < slice.length; j++) {
                            byteNumbers[j] = slice.charCodeAt(j);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                    }
                    
                    const blob = new Blob(byteArrays, { type: mimeType });
                    saveAs(blob, `TSK-${item.taskIdNumber}-${file.name}`);
                } catch (error) {
                    console.error(`Error downloading file ${file.name}:`, error);
                    showAlert(`Failed to download ${file.name}.`, 'error');
                }
            }
            showAlert('All attachments downloaded successfully!', 'success');
        }

        // --- TASK MANAGEMENT FUNCTIONS (CRUD & DISPLAY) ---
        
        window.archiveTask = function(id) {
            if (!confirm("Are you sure you want to archive this task? It will be hidden from the main list.")) return;
            
            const item = allItems.find(i => i.id === id);
            if (!item) return;
            
            const updatedItem = { ...item, status: 'Archived' };
            if (updateItem(id, updatedItem, false)) {
                showAlert('Task successfully archived!', 'warning');
                loadItems();
            } else {
                showAlert('Error archiving task.', 'error');
            }
        }

        function updateItem(id, updatedItem, confirmCompletion = true) {
            const index = allItems.findIndex(item => item.id === id);
            if (index !== -1) {
                if (confirmCompletion && updatedItem.status === 'Completed' && allItems[index].status !== 'Completed') {
                    if (!confirm("Are you sure you want to mark this task as COMPLETED?")) {
                        updatedItem.status = allItems[index].status;
                        return false; 
                    }
                }
                
                const existingItem = allItems[index];
                updatedItem.taskIdNumber = existingItem.taskIdNumber || '';

                allItems[index] = { ...existingItem, ...updatedItem };
                saveItems('taskData', allItems);
                return true;
            }
            return false;
        }

        function deleteItem(id) {
            const initialLength = allItems.length;
            allItems = allItems.filter(item => item.id !== id);
            saveItems('taskData', allItems);
            return allItems.length !== initialLength;
        }

        function getFieldValue(field) {
            const element = document.getElementById(field.id);
            if (!element) return undefined;
            if (field.type === 'number') {
                return parseFloat(element.value);
            }
            return element.value.trim();
        }

        function setFieldValue(field, value) {
            const element = document.getElementById(field.id);
            if (element) {
                element.value = value || '';
            }
        }

        // Currency Formatting Function
        const formatCurrency = (amount) => {
             const numValue = parseFloat(amount);
             if (isNaN(numValue)) return 'N/A';
             return new Intl.NumberFormat('en-IN', { 
                style: 'currency', 
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(numValue);
        }

        function displayFieldValue(field, item) {
            const value = item[field.id];
            if (value === undefined || value === null || value === '') return 'N/A';

            if (field.id === 'taskIdNumber') {
                 return `<span style="font-weight: bold; color: #FF8F00;">${escapeHtml(value)}</span>`;
            } else if (field.id === 'taskAmount') {
                return formatCurrency(value);
            } else if (field.id === 'dueDate') {
                return new Date(value).toLocaleDateString();
            } else if (field.id === 'status') {
                let badgeClass = 'status-pending';
                if (value === 'Allocated') badgeClass = 'status-allocated';
                else if (value === 'In Progress') badgeClass = 'status-in-progress';
                else if (value === 'Completed') badgeClass = 'status-completed';
                else if (value === 'On Hold') badgeClass = 'status-on-hold';
                else if (value === 'Archived') badgeClass = 'status-archived';
                
                return `<span class="status-badge ${badgeClass}">${escapeHtml(value)}</span>`;
            } else if (field.id === 'priority') {
                let color = '#4CAF50';
                if (value === 'Medium') color = '#FF9800';
                else if (value === 'High') color = '#F44336';
                return `<span style="color: ${color}; font-weight: bold;">â—</span> ${escapeHtml(value)}`;
            } else if (field.id === 'assignedTo') {
                const user = userApprovalSystem.getApprovedUsers().find(u => u.name === value);
                const defaultImage = "https://via.placeholder.com/20?text=ðŸ‘¤"; 
                return `
                    <img src="${user?.image || defaultImage}" alt="${value}" style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; vertical-align: middle; object-fit: cover; border: 1px solid #ddd;">
                    ${escapeHtml(value)}`;
            } else if (field.id === 'fileAttachments') {
                if (!Array.isArray(value) || value.length === 0) return 'No Files';
                const fileCount = value.length;
                
                return `
                    <button class="file-download-badge" onclick="downloadAllAttachments('${item.id}')" title="Download all ${fileCount} files">
                        <i class="fas fa-file-download"></i> 
                        ${fileCount} File${fileCount > 1 ? 's' : ''}
                    </button>
                `;
            }
            return escapeHtml(value);
        }

        // Calculate Closing Time
        function calculateClosingTime(dueDate) {
            const now = new Date();
            const due = new Date(dueDate);
            const diff = due - now;
            
            if (diff <= -86400000) {
                return { text: 'Task closed', class: 'timer-closed', sortValue: -diff };
            }
            
            if (diff <= 0) {
                return { text: 'Closing today', class: 'timer-urgent', sortValue: -diff };
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            return { 
                text: `${days}d:${hours}h:${minutes}m:${seconds}s`, 
                class: days > 7 ? 'timer-normal' : (days > 1 ? 'timer-warning' : 'timer-urgent'),
                sortValue: diff
            };
        }

        // Calculate and display total amount
        function updateTotalAmount(items) {
            const total = items.reduce((sum, item) => {
                const amount = parseFloat(item.taskAmount) || 0;
                return sum + amount;
            }, 0);
            
            totalAmountValue.textContent = formatCurrency(total);
        }

        function loadItems() {
            showLoading('Loading tasks...');
            setTimeout(() => {
                allItems = getItems('taskData');
                applyFilters();
                startTimerUpdates();
                hideLoading();
            }, 800);
        }

        function startTimerUpdates() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                if (!formModal.classList.contains('active') && 
                    !deleteModal.classList.contains('active') && 
                    !userManagementModal.classList.contains('active')) {
                    applyFilters();
                }
            }, 1000);
        }
        
        window.handleSubmit = function(e) {
            e.preventDefault();

            const id = document.getElementById('editId').value;
            const item = {};
            let isValid = true;
            
            clearFieldErrors();

            const totalSize = currentAttachments.reduce((sum, file) => sum + (file.size || 0), 0);
            if (currentAttachments.length > MAX_FILE_COUNT || totalSize > MAX_TOTAL_SIZE) {
                showAlert('File validation failed. Please check the file warning message.', 'error');
                return;
            }

            FIELDS.forEach(field => {
                if (field.id !== 'taskIdNumber' && field.id !== 'fileAttachments') {
                    const value = getFieldValue(field);
                    if (field.required && (!value && value !== 0)) {
                        isValid = false;
                    }
                    item[field.id] = value;
                }
            });
            
            item.fileAttachments = currentAttachments;

            const validationErrors = validateTaskData(item);
            if (validationErrors.length > 0) {
                showFieldErrors(validationErrors);
                showAlert('Please fix the validation errors before saving.', 'error');
                return;
            }

            if (!isValid) {
                showAlert('Please fill all required fields.', 'error');
                return;
            }
            
            if (!id) {
                const today = new Date().setHours(0, 0, 0, 0);
                const dueDate = new Date(item.dueDate).setHours(0, 0, 0, 0);
                if (dueDate < today) {
                    showAlert('Due Date cannot be in the past for a new task.', 'error');
                    return;
                }
            }
            
            if (!id) {
                const newTaskId = generateTaskId();
                if (!newTaskId) {
                    showAlert('Failed to create new task. Max task count reached.', 'error');
                    return;
                }
                item.taskIdNumber = newTaskId;
            } else {
                const existingItem = allItems.find(i => i.id === id);
                item.taskIdNumber = existingItem.taskIdNumber;
            }
            
            saveTask(item, id);
        };

        function saveTask(item, id) {
            showLoading(id ? 'Updating task...' : 'Creating task...');
            
            setTimeout(() => {
                if (id) {
                    if (updateItem(id, item)) {
                        showAlert('Task updated successfully!', 'success');
                    } else {
                        hideLoading();
                        return;
                    }
                } else {
                    item.id = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    item.createdAt = new Date().toISOString();
                    if (item.assignedTo && !item.status) {
                        item.status = 'Allocated';
                    }
                    let tasks = getItems('taskData');
                    tasks.push(item);
                    saveItems('taskData', tasks);
                    showAlert(`Task ${item.taskIdNumber} added successfully!`, 'success');
                }
                hideLoading();
                closeFormModal();
                loadItems();
            }, 800);
        }

        // Toggle Archived View 
        window.toggleArchivedView = function() {
            showArchived = !showArchived;
            if (toggleArchivedBtn) {
                if (showArchived) {
                    toggleArchivedBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Archived';
                } else {
                    toggleArchivedBtn.innerHTML = '<i class="fas fa-eye"></i> Show Archived';
                }
            }
            applyFilters();
        }

        function displayItems(items) {
            const visibleFields = FIELDS.filter(f => f.showInTable);
            
            const reorderedFields = [
                visibleFields.find(f => f.id === 'taskIdNumber'),
                visibleFields.find(f => f.id === 'taskName'),
                visibleFields.find(f => f.id === 'assignedTo'),
                visibleFields.find(f => f.id === 'changesRequired'),
                visibleFields.find(f => f.id === 'fileAttachments'),
                visibleFields.find(f => f.id === 'taskAmount'),
                visibleFields.find(f => f.id === 'priority'),
                visibleFields.find(f => f.id === 'status'),
                visibleFields.find(f => f.id === 'dueDate')
            ].filter(f => f !== undefined);
            
            const visibleFieldsCount = reorderedFields.length + 2; // + Created Date & Closing Time

            if (items.length === 0 && searchInput.value === '') {
                tableBody.innerHTML = `<tr><td colspan="${visibleFieldsCount + 1}" class="empty-state"><h3>No tasks yet</h3><p>Click "Add New Task" to get started</p></td></tr>`;
                return;
            } else if (items.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="${visibleFieldsCount + 1}" class="empty-state"><h3>No tasks found</h3><p>Try adjusting filters or search</p></td></tr>`;
                return;
            }

            tableBody.innerHTML = items.map((item, index) => {
                const createdDate = new Date(item.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const closingTime = item.dueDate ? calculateClosingTime(item.dueDate) : { text: 'No due date', class: 'timer-normal' };
                const isArchived = item.status === 'Archived';
                const isSelected = selectedTasks.has(item.id);

                const cells = [
                    `<div class="checkbox-column"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleTaskSelection('${item.id}', this.checked)"></div>`,
                    ...reorderedFields.map(field => {
                        return displayFieldValue(field, item);
                    }),
                    createdDate,
                    `<div class="timer ${closingTime.class}">${closingTime.text}</div>`
                ];

                const rowClass = isArchived ? 'archived-row' : '';
                return `<tr class="${rowClass}">${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
            }).join('');
        }
        
        function displayCards(items) {
            const cardContainer = document.getElementById('cardView');

            if (items.length === 0 && searchInput.value === '') {
                cardContainer.innerHTML = `<div class="empty-state"><h3>No tasks yet</h3><p>Click "Add New Task" to get started</p></div>`;
                return;
            } else if (items.length === 0) {
                cardContainer.innerHTML = `<div class="empty-state"><h3>No tasks found</h3><p>Try adjusting your search or filters</p></div>`;
                return;
            }

            cardContainer.innerHTML = items.map((item, index) => {
                const createdDate = new Date(item.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                const dueDate = item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A';
                const closingTime = item.dueDate ? calculateClosingTime(item.dueDate) : { text: 'No due date', class: 'timer-normal' };

                const priorityColors = {
                    'High': '#F44336',
                    'Medium': '#FF9800',
                    'Low': '#4CAF50',
                    'Archived': '#5D4037'
                };

                const statusBadgeClasses = {
                    'Allocated': 'status-allocated',
                    'In Progress': 'status-in-progress',
                    'Completed': 'status-completed',
                    'On Hold': 'status-on-hold',
                    'Archived': 'status-archived'
                };
                
                const isArchived = item.status === 'Archived';
                const isFreeTask = !item.taskAmount || item.taskAmount === 0;
                
                const taskNumberDisplay = item.taskIdNumber ? `<div style="font-size: 0.9em; color: #FF8F00; font-weight: bold;">${item.taskIdNumber}</div>` : '';
                
                const filesCount = Array.isArray(item.fileAttachments) ? item.fileAttachments.length : 0;
                const fileAttachmentDisplay = filesCount > 0 
                    ? `<div class="card-field">
                           <div class="card-label">Attachments:</div>
                           <div class="card-value">
                                <button class="file-download-badge" onclick="downloadAllAttachments('${item.id}')" title="Download all ${filesCount} files">
                                    <i class="fas fa-file-download"></i> 
                                    ${filesCount} File${filesCount > 1 ? 's' : ''}
                                </button>
                           </div>
                       </div>`
                    : `<div class="card-field"><div class="card-label">Attachments:</div><div class="card-value">No Files</div></div>`;


                return `
                    <div class="task-card ${isFreeTask ? 'free-task' : ''}" style="border-left-color: ${priorityColors[item.priority] || priorityColors[item.status] || '#FFA000'}; opacity: ${isArchived ? 0.7 : 1};">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${escapeHtml(item.taskName || 'Untitled Task')}</div>
                                <div class="timer ${closingTime.class}">${closingTime.text}</div>
                            </div>
                            <div style="text-align: right;">
                                ${taskNumberDisplay}
                                <div class="status-badge ${statusBadgeClasses[item.status] || 'status-pending'}">${item.status}</div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card-field">
                                <div class="card-label">Assigned To:</div>
                                <div class="card-value">
                                    ${item.assignedTo ? `
                                        <div style="display: flex; align-items: center;">
                                            <img src="${userApprovalSystem.getApprovedUsers().find(u => u.name === item.assignedTo)?.image || 'https://via.placeholder.com/20?text=ðŸ‘¤'}" 
                                                 alt="${item.assignedTo}" 
                                                 style="width: 20px; height: 20px; border-radius: 50%; margin-right: 5px; object-fit: cover; border: 1px solid #ddd;">
                                            ${escapeHtml(item.assignedTo)}
                                        </div>
                                    ` : 'N/A'}
                                </div>
                            </div>
                            <div class="card-field">
                                <div class="card-label">Changes Required:</div>
                                <div class="card-value">${escapeHtml(item.changesRequired || 'N/A')}</div>
                            </div>
                            ${fileAttachmentDisplay}
                            <div class="card-field">
                                <div class="card-label">Amount:</div>
                                <div class="card-value">${item.taskAmount ? formatCurrency(item.taskAmount) : 'Free'}</div>
                            </div>
                            <div class="card-field">
                                <div class="card-label">Priority:</div>
                                <div class="card-value" style="color: ${priorityColors[item.priority] || '#666'}">${item.priority}</div>
                            </div>
                            <div class="card-field">
                                <div class="card-label">Due Date:</div>
                                <div class="card-value">${dueDate}</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div style="font-size: 0.85em; color: #666;">Created: ${createdDate}</div>
                            <div class="card-actions">
                                ${isArchived 
                                    ? `<button class="btn btn-sm btn-edit" onclick="openEditModal('${item.id}')" title="Unarchive Task"><i class="fas fa-undo"></i></button>`
                                    : `<button class="btn btn-sm btn-edit" onclick="openEditModal('${item.id}')"><i class="fas fa-edit"></i></button>
                                       <button class="btn btn-sm btn-secondary" style="background: #90A4AE;" onclick="archiveTask('${item.id}')" title="Archive Task"><i class="fas fa-archive"></i></button>`
                                }
                                <button class="btn btn-sm btn-danger" onclick="openDeleteModal('${item.id}')"><i class="fas fa-trash"></i></button>
                                <button class="btn btn-sm btn-print" onclick="printSingleCard('${item.id}')" title="Print Task Slip"><i class="fas fa-print"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleView = function() {
            isCardView = !isCardView;
            
            if (isCardView) {
                tableView.style.display = 'none';
                cardView.style.display = 'grid';
                toggleViewBtn.innerHTML = '<i class="fas fa-table"></i> Table View';
                toggleViewBtn.classList.add('active');
                displayCards(allItems);
            } else {
                tableView.style.display = 'block';
                cardView.style.display = 'none';
                toggleViewBtn.innerHTML = '<i class="fas fa-th"></i> Card View';
                toggleViewBtn.classList.remove('active');
                displayItems(allItems);
            }
        }
        
        window.openDeleteModal = function(id) {
            const item = allItems.find(i => i.id === id);
            if (!item) return;

            deleteItemId = id;
            document.getElementById('deleteItemInfo').innerHTML = `
                Task No: <strong>${escapeHtml(item.taskIdNumber)}</strong><br>
                Name: <strong>${escapeHtml(item.taskName)}</strong>
            `;
            deleteModal.classList.add('active');
        }

        window.closeDeleteModal = function() {
            deleteModal.classList.remove('active');
            deleteItemId = null;
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            if (!deleteItemId) return;
            
            showLoading('Deleting task...');
            setTimeout(() => {
                if (deleteItem(deleteItemId)) {
                    showAlert('Task deleted successfully!', 'success');
                    loadItems();
                } else {
                    showAlert('Error: Could not delete task', 'error');
                }
                hideLoading();
                closeDeleteModal();
            }, 500);
        });

        // --- MODAL FUNCTIONS ---

        window.openAddModal = function() {
            if (!userApprovalSystem.isLoggedIn()) {
                showAlert('Please login first!', 'error');
                openLoginModal();
                return;
            }
            
            if (!userApprovalSystem.isAdmin()) {
                showAlert('Only admin can create tasks!', 'error');
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Add New Task';
            document.getElementById('submitBtn').textContent = 'Save';
            document.getElementById('editId').value = '';
            itemForm.reset();
            currentAttachments = [];
            fileAttachmentsInput.value = '';
            renderFileAttachmentsList();
            clearFieldErrors();
            generateFormFields();
            formModal.classList.add('active');
        };
        
        window.closeFormModal = function() {
            formModal.classList.remove('active');
            itemForm.reset();
            currentAttachments = [];
            fileAttachmentsInput.value = '';
            fileWarning.textContent = '';
            clearFieldErrors();
        };

        window.openEditModal = function(id) {
            if (!userApprovalSystem.isLoggedIn()) {
                showAlert('Please login first!', 'error');
                openLoginModal();
                return;
            }
            
            const item = allItems.find(i => i.id === id);
            if (!item) return;

            document.getElementById('modalTitle').textContent = item.status === 'Archived' ? 'Unarchive/Edit Task' : 'Edit Task';
            document.getElementById('submitBtn').textContent = item.status === 'Archived' ? 'Unarchive & Update' : 'Update';
            document.getElementById('editId').value = id;
            
            generateFormFields();
            
            currentAttachments = JSON.parse(JSON.stringify(item.fileAttachments || []));
            renderFileAttachmentsList();
            fileAttachmentsInput.value = '';
            
            if (item.status === 'Archived') {
                 setFieldValue(FIELDS.find(f => f.id === 'status'), 'Allocated');
                 showAlert('This task was archived. It has been set to "Allocated" for immediate action. Change status if needed.', 'warning');
            }

            FIELDS.forEach(field => {
                if (field.id !== 'status' && field.id !== 'fileAttachments') { 
                    setFieldValue(field, item[field.id]);
                } else if (field.id === 'status' && item.status !== 'Archived') {
                    setFieldValue(field, item[field.id]);
                }
            });

            formModal.classList.add('active');
        };
        
        // --- UTILITY FUNCTIONS --- 

        function showAlert(message, type, duration = 3000) {
            alertBox.innerHTML = message;
            alertBox.className = `alert alert-${type} active`;
            setTimeout(() => {
                alertBox.className = 'alert';
            }, duration);
        }
        
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- EXPORT & PRINT FUNCTIONS --- 
        
        window.exportToExcel = function() {
            if (!userApprovalSystem.isAdmin()) {
                showAlert('Only admin can export data!', 'error');
                return;
            }
            
            showLoading('Exporting to Excel...');
            setTimeout(() => {
                const table = document.getElementById('dataTable');
                const ws_data = [];
                const headers = [];
                
                const headerRow = table.querySelector('thead tr');
                headerRow.querySelectorAll('th').forEach(th => {
                    const headerText = th.textContent.trim();
                    if (headerText !== 'Actions' && headerText !== 'Closing Time' && headerText !== '') {
                        headers.push(headerText);
                    }
                });
                ws_data.push(headers);
                
                const bodyRows = table.querySelector('tbody').querySelectorAll('tr');
                
                if (bodyRows.length === 1 && (bodyRows[0].classList.contains('empty-state') || bodyRows[0].querySelector('td').classList.contains('loading'))) {
                    showAlert('No data to export!', 'error');
                    hideLoading();
                    return;
                }

                bodyRows.forEach(row => {
                    const rowData = [];
                    const cells = Array.from(row.querySelectorAll('td'));
                    
                    for (let i = 1; i < cells.length; i++) {
                        let cellText = cells[i].textContent.trim();
                        
                        const headerText = headers[i-1];
                        
                        if (headerText === 'Task Amount') {
                            cellText = cells[i].textContent.replace('â‚¹', '').replace(/,/g, '').trim();
                        } else if (headerText === 'Assigned To' || headerText === 'Status' || headerText === 'Priority') {
                            const textOnly = cells[i].textContent.replace(/â—/g, '').replace(/\s+/g, ' ').trim(); 
                            cellText = textOnly;
                        } else if (headerText === 'Files') {
                            const fileCountMatch = cells[i].textContent.match(/(\d+)\s+File/);
                            cellText = fileCountMatch ? `${fileCountMatch[1]} files` : 'No Files';
                        } else if (headerText === 'Closing Time') {
                            continue;
                        }
                        
                        rowData.push(cellText);
                    }
                    
                    if (rowData.length > 0) {
                        ws_data.push(rowData);
                    }
                });

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "TaskData"); 

                const excelFileName = `Task_Management_Report_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, excelFileName);
                
                hideLoading();
                showAlert('Data exported to Excel successfully!', 'success');
            }, 1000);
        };
        
        window.printAllCards = function() {
            const searchTerm = searchInput.value.toLowerCase();
            let itemsToPrint = allItems;

            if (searchTerm !== '') {
                const searchableFields = FIELDS.filter(f => f.searchable);
                itemsToPrint = itemsToPrint.filter(item =>
                    searchableFields.some(field =>
                        item[field.id] && item[field.id].toString().toLowerCase().includes(searchTerm)
                    )
                );
            }
            
            if (!showArchived) {
                itemsToPrint = itemsToPrint.filter(item => item.status !== 'Archived');
            }

            if (itemsToPrint.length === 0) {
                alert('No tasks to print!');
                return;
            }

            const printContent = document.getElementById('printContent');
            const now = new Date().toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            const printFields = FIELDS.filter(f => f.showInPrint);

            let cardsHtml = `
                <div class="print-slip-header"><h2>TASK DETAILS REPORT</h2><p>Printed: ${now}</p><p>Total Tasks: ${itemsToPrint.length}</p></div>
            `;

            itemsToPrint.forEach((item, index) => {
                const createdDate = new Date(item.createdAt).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
                
                const dueDate = item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A';
                
                const fieldValues = printFields.map(field => {
                    let value = item[field.id] || 'N/A';
                    if (field.id === 'taskAmount' && value !== 'N/A') {
                        value = formatCurrency(value);
                    } else if (field.id === 'fileAttachments') {
                        const count = Array.isArray(value) ? value.length : 0;
                        value = count > 0 ? `${count} File${count > 1 ? 's' : ''} Attached` : 'No Files';
                    }
                    return `<div class="card-row"><div class="card-label">${field.label}:</div><div class="card-value">${escapeHtml(value)}</div></div>`;
                }).join('');
                
                cardsHtml += `<div class="student-card"><div class="card-number">${item.taskIdNumber || 'TASK #N/A'}</div>
                    ${fieldValues}
                    <div class="card-row"><div class="card-label">Created Date:</div><div class="card-value">${createdDate}</div></div>
                    <div class="card-row"><div class="card-label">Due Date:</div><div class="card-value">${dueDate}</div></div>
                </div>`;
            });

            cardsHtml += `<div class="print-slip-footer"><p>Task Management System - Report</p><p>End of Report</p></div>`;

            printContent.innerHTML = cardsHtml;
            window.print();
        };

        window.printSingleCard = function(id) {
            const item = allItems.find(i => i.id === id);
            if (!item) return;

            const printContent = document.getElementById('printContent');
            const now = new Date().toLocaleString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            const createdDate = new Date(item.createdAt).toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric'
            });

            const printFields = FIELDS.filter(f => f.showInPrint);
            
            const fieldValues = printFields.map(field => {
                let value = item[field.id] || 'N/A';
                if (field.id === 'taskAmount' && value !== 'N/A') {
                    value = formatCurrency(value); 
                } else if (field.id === 'fileAttachments') {
                    const count = Array.isArray(value) ? value.length : 0;
                    value = count > 0 ? `${count} File${count > 1 ? 's' : ''} Attached` : 'No Files';
                }
                return `<div class="card-row"><div class="card-label">${field.label}:</div><div class="card-value">${escapeHtml(value)}</div></div>`;
            }).join('');
            
            const cardHtml = `
                <div class="print-slip-header"><h2>TASK DETAIL</h2><p>Printed: ${now}</p></div>
                <div class="student-card">
                    <div class="card-number">${item.taskIdNumber || 'TASK #N/A'}</div>
                    ${fieldValues}
                    <div class="card-row"><div class="card-label">Created Date:</div><div class="card-value">${createdDate}</div></div>
                    <div class="card-row"><div class="card-label">Due Date:</div><div class="card-value">${item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A'}</div></div>
                </div>
                <div class="print-slip-footer"><p>Task Management System - Task Detail</p><p>End of Card</p></div>
            `;

            printContent.innerHTML = cardHtml;
            window.print();
        };
        
        // --- LOGOUT FUNCTION --- 
        window.handleLogout = function() {
            if (confirm("Are you sure you want to log out? All unsaved changes will be lost (Note: Data is automatically saved to Local Storage).")) {
                showLoading('Logging out...');
                setTimeout(() => {
                    userApprovalSystem.logout();
                    window.location.reload(); 
                }, 1000);
            }
        }

        // --- FILTERING AND SORTING FUNCTIONS --- 

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            
            // Advanced search filters
            const filterAssignee = searchAssignee.value;
            const filterStatus = searchStatus.value;
            const filterPriority = searchPriority.value;
            const filterAmountMin = parseFloat(searchAmountMin.value) || 0;
            const filterAmountMax = parseFloat(searchAmountMax.value) || Infinity;
            const filterDateFrom = searchDateFrom.value;
            const filterDateTo = searchDateTo.value;
            
            let filtered = allItems;
            
            // 1. Archiving Filter
            if (!showArchived) {
                filtered = filtered.filter(item => item.status !== 'Archived');
            }
            
            // 2. Search Filter
            if (searchTerm !== '') {
                const searchableFields = FIELDS.filter(f => f.searchable);
                filtered = filtered.filter(item =>
                    searchableFields.some(field =>
                        item[field.id] && item[field.id].toString().toLowerCase().includes(searchTerm)
                    )
                );
            }
            
            // 3. Advanced Search Filters
            if (filterAssignee) {
                filtered = filtered.filter(item => item.assignedTo === filterAssignee);
            }
            
            if (filterStatus) {
                filtered = filtered.filter(item => item.status === filterStatus);
            }
            
            if (filterPriority) {
                filtered = filtered.filter(item => item.priority === filterPriority);
            }
            
            if (filterAmountMin > 0 || filterAmountMax < Infinity) {
                filtered = filtered.filter(item => {
                    const amount = parseFloat(item.taskAmount) || 0;
                    return amount >= filterAmountMin && amount <= filterAmountMax;
                });
            }
            
            if (filterDateFrom) {
                filtered = filtered.filter(item => new Date(item.dueDate) >= new Date(filterDateFrom));
            }
            
            if (filterDateTo) {
                filtered = filtered.filter(item => new Date(item.dueDate) <= new Date(filterDateTo));
            }
            
            // 4. Sorting
            filtered = sortItems(filtered, currentSort.key, currentSort.direction);

            // Update total amount display
            updateTotalAmount(filtered);

            // Update dashboard stats
            updateDashboardStats();

            if (isCardView) {
                displayCards(filtered);
            } else {
                displayItems(filtered);
            }
        }
        
        // Core Sorting Logic
        function sortItems(items, key, direction) {
            if (!key) return items;

            return items.sort((a, b) => {
                let valA = a[key];
                let valB = b[key];

                if (key === 'taskIdNumber') {
                    valA = getTaskNumberForSorting(valA);
                    valB = getTaskNumberForSorting(valB);
                } else if (key === 'taskAmount') {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                } else if (key === 'dueDate' || key === 'createdAt') {
                    valA = new Date(valA || 0).getTime();
                    valB = new Date(valB || 0).getTime();
                } else if (key === 'timeRemaining') {
                    valA = a.dueDate ? calculateClosingTime(a.dueDate).sortValue : Infinity;
                    valB = b.dueDate ? calculateClosingTime(b.dueDate).sortValue : Infinity;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                } else {
                    valA = valA === undefined || valA === null ? (direction === 'asc' ? Infinity : -Infinity) : valA;
                    valB = valB === undefined || valB === null ? (direction === 'asc' ? Infinity : -Infinity) : valB;
                }

                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // ===== ADVANCED SEARCH & FILTERS =====
        
        function toggleAdvancedSearch() {
            advancedSearchPanel.classList.toggle('active');
            bulkActionsPanel.classList.remove('active');
        }
        
        function populateAssigneeFilters() {
            searchAssignee.innerHTML = '<option value="">All Assignees</option>';
            userApprovalSystem.getApprovedUsers().forEach(user => {
                searchAssignee.innerHTML += `<option value="${escapeHtml(user.name)}">${escapeHtml(user.name)}</option>`;
            });
        }
        
        function populateBulkAssigneeSelect() {
            bulkAssigneeSelect.innerHTML = '<option value="">Update Assignee</option>';
            userApprovalSystem.getApprovedUsers().forEach(user => {
                bulkAssigneeSelect.innerHTML += `<option value="${escapeHtml(user.name)}">${escapeHtml(user.name)}</option>`;
            });
        }
        
        // ===== BULK OPERATIONS =====
        
        function toggleBulkActions() {
            bulkActionsPanel.classList.toggle('active');
            advancedSearchPanel.classList.remove('active');
        }
        
        function toggleTaskSelection(taskId, isSelected) {
            if (isSelected) {
                selectedTasks.add(taskId);
            } else {
                selectedTasks.delete(taskId);
            }
        }
        
        function bulkUpdateStatus() {
            if (selectedTasks.size === 0) {
                showAlert('Please select tasks to update.', 'error');
                return;
            }
            
            const newStatus = bulkStatusSelect.value;
            if (!newStatus) {
                showAlert('Please select a status from the dropdown.', 'error');
                return;
            }
            
            showLoading('Updating tasks...');
            setTimeout(() => {
                let updatedCount = 0;
                selectedTasks.forEach(taskId => {
                    const item = allItems.find(i => i.id === taskId);
                    if (item) {
                        item.status = newStatus;
                        updatedCount++;
                    }
                });
                
                saveItems('taskData', allItems);
                showAlert(`Updated status for ${updatedCount} task(s) to "${newStatus}"`, 'success');
                bulkStatusSelect.value = '';
                loadItems();
                hideLoading();
            }, 500);
        }
        
        function bulkUpdateAssignee() {
            if (selectedTasks.size === 0) {
                showAlert('Please select tasks to update.', 'error');
                return;
            }
            
            const newAssignee = bulkAssigneeSelect.value;
            if (!newAssignee) {
                showAlert('Please select an assignee from the dropdown.', 'error');
                return;
            }
            
            showLoading('Updating tasks...');
            setTimeout(() => {
                let updatedCount = 0;
                selectedTasks.forEach(taskId => {
                    const item = allItems.find(i => i.id === taskId);
                    if (item) {
                        item.assignedTo = newAssignee;
                        updatedCount++;
                    }
                });
                
                saveItems('taskData', allItems);
                showAlert(`Updated assignee for ${updatedCount} task(s) to "${newAssignee}"`, 'success');
                bulkAssigneeSelect.value = '';
                loadItems();
                hideLoading();
            }, 500);
        }
        
        function bulkDeleteTasks() {
            if (selectedTasks.size === 0) {
                showAlert('Please select tasks to delete.', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete ${selectedTasks.size} task(s)?`)) {
                return;
            }
            
            showLoading('Deleting tasks...');
            setTimeout(() => {
                const initialLength = allItems.length;
                allItems = allItems.filter(item => !selectedTasks.has(item.id));
                saveItems('taskData', allItems);
                
                const deletedCount = initialLength - allItems.length;
                showAlert(`Deleted ${deletedCount} task(s)`, 'success');
                loadItems();
                hideLoading();
            }, 500);
        }
        
        // ===== HELP & SUPPORT FUNCTIONS =====
        
        window.openHelpModal = function() {
            helpModal.classList.add('active');
        }
        rgba(237,18,18,0.78)
        window.closeHelpModal = function() {
            helpModal.classList.remove('active');
        }
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.innerHTML = `
                <div class="message-sender">You</div>
                <div>${escapeHtml(message)}</div>
            `;
            chatMessages.appendChild(userMessageDiv);
            
            // Clear input
            chatInput.value = '';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Simulate admin response after a delay
            setTimeout(() => {
                const responses = [
                    "I understand your concern. Let me help you with that.",
                    "Thank you for reaching out. Our team will get back to you soon.",
                    "I've noted your question. Is there anything else I can help with?",
                    "That's a great question! Let me check our documentation for you.",
                    "I appreciate your feedback. We're constantly working to improve the system."
                ];
                
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                const adminMessageDiv = document.createElement('div');
                adminMessageDiv.className = 'message admin-message';
                adminMessageDiv.innerHTML = `
                    <div class="message-sender">Admin</div>
                    <div>${randomResponse}</div>
                `;
                chatMessages.appendChild(adminMessageDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1000);
        }
        
        // Allow sending message with Enter key
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ===== INITIALIZATION =====
        function initializeUserSystem() {
            // Check if user is logged in
            if (!userApprovalSystem.isLoggedIn()) {
                // Show login modal on page load
                setTimeout(() => {
                    openLoginModal();
                }, 1000);
            } else {
                updateUIForUser();
            }
            
            renderPendingUsers();
        }

        // Initialize Data and UI
        initializeData();
        loadUsers(); 
        generateTableHeader();
        loadItems();
        setupKeyboardShortcuts();
        initializeUserSystem();

        searchInput.addEventListener('input', applyFilters);

        // Global event listeners for modals
        window.addEventListener('click', (e) => {
            if (e.target === formModal) closeFormModal();
            if (e.target === deleteModal) closeDeleteModal();
            if (e.target === userManagementModal) closeUserModal();
            if (e.target === userDeleteModal) closeUserDeleteModal();
            if (e.target === helpModal) closeHelpModal();
            if (e.target === loginModal) closeLoginModal();
            if (e.target === signupModal) closeSignupModal();
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFormModal();
                closeDeleteModal();
                closeUserModal();
                closeUserDeleteModal();
                closeHelpModal();
                closeLoginModal();
                closeSignupModal();
            }
        });
    </script>
</body>
                    </html>
